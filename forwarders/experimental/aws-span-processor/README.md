# AWS Span Processor

AWS Lambda function and supporting resources that forward CloudWatch logs containing OTLP spans to OpenTelemetry collectors. 

> [!NOTE]
> This is an experimental implementation that is not recommended for production use.

## Overview

This stack deploys:
1. A Lambda function that receives span events from the CloudWatch Application Signals log group `aws/spans` 
2. Converts them to OTLP json format spans
3. Forwards the data to the configured OTLP collectors in parallel

This enables you to use your own OpenTelemetry collectors with traces generated by AWS Application Signals' zero-code instrumentation. The AWS implementation is highly optimized for Lambda environments through a custom OTLP over UDP exporter. This approach significantly reduces both warm and cold start latencies while requiring no code changes to implement.
Currently, span events from Application Signals are logged individually rather than batched per execution, resulting in many small requests to the collector. While it would be possible to aggregate spans by trace ID using a service like Kinesis as a transport layer (using trace ID as the partition key), this optimization has been deferred to avoid adding unnecessary complexity in the initial implementation. Future versions may explore batching strategies to reduce collector load.

## Features

- Supports multiple collectors with different endpoints with the same configuration as the forwarder
- Supports custom headers and authentication
- Supports gzip compresseion for OTLP payloads

## Prerequisites

- Rust 1.70 or later
- AWS SAM CLI
- AWS credentials configured

## Building

```bash
# Navigate to the forwarder directory
cd forwarders/experimental/aws-span-processor

# Run tests
cargo test --package aws-span-processor

# Build the stack
sam build
```

## Deployment

1. First time deployment:
```bash
sam deploy --guided --stack-name aws-span-processor
```

2. Subsequent deployments:
```bash
sam build && sam deploy --stack-name aws-span-processor
```
